#!/usr/bin/env bash
# reset_dns.sh
# ä½œç”¨ï¼šå½»åº•å…³é—­æœ¬åœ° DNSï¼ˆsystemd-resolved / 127.0.0.53ï¼‰
#       é‡å»ºä¸ºç”¨æˆ·è‡ªå®šä¹‰ DNSï¼Œå¹¶è¿›è¡ŒéªŒè¯
# é€‚ç”¨ï¼šUbuntu / Debian / CentOS / Alma / Rocky / Fedora / VPS é€šç”¨

set -e

TIMESTAMP=$(date +%Y%m%d-%H%M%S)
BACKUP_DIR="/root/dns-reset-backup-$TIMESTAMP"
mkdir -p "$BACKUP_DIR"

echo "ğŸ“¦ å¤‡ä»½ç›®å½•ï¼š$BACKUP_DIR"

# ----------------------------
# 1. è¯»å–ç”¨æˆ· DNS
# ----------------------------
if [ "$#" -gt 0 ]; then
  DNS_SERVERS=("$@")
else
  read -rp "è¯·è¾“å…¥æ–°çš„ DNSï¼ˆç©ºæ ¼åˆ†éš”ï¼Œå¦‚ 1.1.1.1 8.8.8.8ï¼‰ï¼š " -a DNS_SERVERS
fi

if [ "${#DNS_SERVERS[@]}" -eq 0 ]; then
  echo "âŒ æœªè¾“å…¥ DNSï¼Œé€€å‡º"
  exit 1
fi

echo "âœ… æ–° DNSï¼š${DNS_SERVERS[*]}"
sleep 1

# ----------------------------
# 2. å½»åº•å…³é—­ systemd-resolved
# ----------------------------
if systemctl list-unit-files | grep -q systemd-resolved; then
  echo "ğŸ›‘ å…³é—­ systemd-resolved..."
  systemctl stop systemd-resolved || true
  systemctl disable systemd-resolved || true

  cp -a /etc/systemd/resolved.conf "$BACKUP_DIR/" 2>/dev/null || true
fi

# ----------------------------
# 3. è§£é™¤ resolv.conf è½¯é“¾æ¥
# ----------------------------
if [ -L /etc/resolv.conf ]; then
  echo "ğŸ”— è§£é™¤ /etc/resolv.conf è½¯é“¾æ¥"
  cp -a /etc/resolv.conf "$BACKUP_DIR/resolv.conf.link.bak"
  rm -f /etc/resolv.conf
fi

# ----------------------------
# 4. å…³é—­ NetworkManager è‡ªåŠ¨ DNS
# ----------------------------
if command -v nmcli >/dev/null 2>&1; then
  echo "ğŸ›‘ ç¦æ­¢ NetworkManager è‡ªåŠ¨æ§åˆ¶ DNS"
  NM_CONN=$(nmcli -t -f NAME c show --active | head -n1)
  if [ -n "$NM_CONN" ]; then
    nmcli c modify "$NM_CONN" ipv4.ignore-auto-dns yes || true
    nmcli c modify "$NM_CONN" ipv6.ignore-auto-dns yes || true
    nmcli c up "$NM_CONN" || true
  fi
fi

# ----------------------------
# 5. å†™å…¥å…¨æ–°çš„ resolv.conf
# ----------------------------
echo "âœï¸ é‡å»º /etc/resolv.conf"
cat > /etc/resolv.conf <<EOF
# Generated by reset_dns.sh at $TIMESTAMP
$(for d in "${DNS_SERVERS[@]}"; do echo "nameserver $d"; done)
options timeout:2 attempts:2 rotate
EOF

chmod 644 /etc/resolv.conf

# ----------------------------
# 6. DNS ç”Ÿæ•ˆéªŒè¯
# ----------------------------
echo "ğŸ” å¼€å§‹ DNS éªŒè¯..."
echo ""

TEST_DOMAIN="example.com"

if command -v dig >/dev/null 2>&1; then
  TOOL="dig"
elif command -v nslookup >/dev/null 2>&1; then
  TOOL="nslookup"
elif command -v host >/dev/null 2>&1; then
  TOOL="host"
else
  TOOL="none"
fi

for dns in "${DNS_SERVERS[@]}"; do
  echo "â¡ï¸ æµ‹è¯• DNSï¼š$dns"

  case "$TOOL" in
    dig)
      dig @"$dns" "$TEST_DOMAIN" +time=2 +tries=1 +short && echo "âœ… æˆåŠŸ" || echo "âŒ å¤±è´¥"
      ;;
    nslookup)
      nslookup "$TEST_DOMAIN" "$dns" && echo "âœ… æˆåŠŸ" || echo "âŒ å¤±è´¥"
      ;;
    host)
      host "$TEST_DOMAIN" "$dns" && echo "âœ… æˆåŠŸ" || echo "âŒ å¤±è´¥"
      ;;
    *)
      echo "âš ï¸ æœªå®‰è£… dig/nslookup/hostï¼Œè·³è¿‡å•ç‹¬ DNS éªŒè¯"
      getent ahosts "$TEST_DOMAIN" && echo "âœ… ç³»ç»Ÿè§£ææ­£å¸¸" || echo "âŒ ç³»ç»Ÿè§£æå¤±è´¥"
      ;;
  esac

  echo ""
done

# ----------------------------
# 7. å½“å‰ç³»ç»Ÿ DNS çŠ¶æ€
# ----------------------------
echo "ğŸ“¡ å½“å‰ç”Ÿæ•ˆçš„ /etc/resolv.confï¼š"
cat /etc/resolv.conf

echo ""
echo "âœ… DNS å½»åº•é‡ç½®å®Œæˆï¼"
echo "ğŸ“‚ å¤‡ä»½ç›®å½•ï¼š$BACKUP_DIR"

echo ""
echo "ğŸ” å¦‚éœ€å›æ»šï¼š"
echo "sudo cp -a $BACKUP_DIR/resolv.conf.link.bak /etc/resolv.conf"
